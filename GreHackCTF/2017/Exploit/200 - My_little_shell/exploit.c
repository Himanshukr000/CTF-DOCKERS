#include <stdlib.h>
#include <stdio.h>
#include <string.h>
#include <unistd.h>
#include <openssl/sha.h>

typedef void (*func_ptr)(void);
// $ echo -n 'username:john|password:john' | sha1sum 
// const char valid_creds[] = "\x51\xb1\x98\x28\x6a\xd9\x62\xd4\xa2\xe7\x8c\x01\x91\xc3\x54\x19\x5c\x58\xe2\x0b";
// $ echo -n 'username:john|password:ub;AnXQrRwQuDWmK@#!AtUTw,"o#Cm}nNqLvL\?\BRPYL)z{j-G{XVfYgSP8#9' | sha1sum 
const char valid_creds[] = "\xbd\xa8\xf0\x4f\x8b\xbf\x6d\x4e\xd0\x68\x84\xdd\x1f\xd2\xee\x5d\x0b\xa7\x5e\xa1";

int do_login() {
 char creds[256] = {0};
 char username[128] = {0};
 char password[128] = {0};
 printf("Username: ");
 fflush(stdout);
 fgets(username, 128, stdin);
 username[strcspn(username, "\n")] = '\0';
 printf("Password: ");
 fflush(stdout);
 fgets(password, 128, stdin);
 password[strcspn(password, "\n")] = '\0';
 // Stack-based buffer overflow.
 sprintf(creds, "username:%s|password:%s", username, password);
 if (strcmp(valid_creds, SHA1(creds, strlen(creds), NULL))) {
  printf("Invalid password for ");
  // Format string vuln.
  printf(username);
  printf("\n");
  fflush(stdout);
  return -1;
 }
 return 0;
}

void get_id() {
 printf("Current ID:\n");
 fflush(stdout);
 system("id");
}

void get_time() {
 printf("Current time:\n");
 fflush(stdout);
 system("date");
}

void get_ls() {
 printf("List of current directories:\n");
 fflush(stdout);
 system("ls");
}

// Padding for get_shell address ending with a NULL byte.
void dummy() {
 unsigned long long i = 0xffffffff00000000;
}

void get_uptime() {
 printf("Current uptime:\n");
 fflush(stdout);
 system("uptime");
}

void get_shell() {
 int i = -1;
 if (!(i = do_login()))
  execlp("/bin/sh", "sh", NULL);
}

void get_help() {
 printf("MyLittleShell v0.1\n");
 printf("\n");
 printf("\tMade for lazy admins; by lazy admins\n");
 printf("\n");
 printf("\t  help: Print this message\n");
 printf("\t  bash: Get interactive shell (disabled for safety reasons)\n");
 printf("\t    ls: List current files and directories\n");
 printf("\t  date: Display current time of the system\n");
 printf("\tuptime: Get current uptime of the machine\n");
 printf("\t    id: Show user and group information\n\n");
 fflush(stdout);
}

int main(void) {
 func_ptr functions[6] = {
  &get_help,
  &get_shell,
  &get_ls,
  &get_time,
  &get_uptime,
  &get_id
 };
 char buf[16] = {0};
 unsigned long choice = 0;

 printf("MyLittleShell v0.1\n");
 fflush(stdout);

 while (1) {
  printf("List of functions:\n");
  printf("\t1. help\n");
  printf("\t2. bash\n");
  printf("\t3. ls\n");
  printf("\t4. date\n");
  printf("\t5. uptime\n");
  printf("\t6. id\n");
  fflush(stdout);
  // Off-by-one stack-based buffer overflow.
  scanf("%16s", buf);
  do{
   choice = getchar();
  }while(choice != EOF && choice != '\n');
  choice = atol(buf) - 1;  // if atol err; ret 0; underflow; choice = max_int; ok
  if (choice > 5)
   printf("Invalid function!!!\n");
  else if (choice == 1)
   printf("Function disabled!!!\n");
  else
   (*(functions[choice]))();
  fflush(stdout);
 }
 return 0;
}
