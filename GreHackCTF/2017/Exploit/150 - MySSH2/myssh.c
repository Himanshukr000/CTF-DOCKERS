#include <openssl/sha.h>
#include <stdio.h>
#include <stdlib.h>
#include <string.h>
#include <unistd.h>
#include <syslog.h>

#define MAX_SIZE 256
#define LOGIN "john"
#define HASH "\x8b\xb1\xc6\xa8\x13\x7e\x63\x1b\x79\xaf\x07\x71\xbf\x76\xdc\x76\x08\x94\x98\x20"

void executeShell()
{
	printf("Hello "LOGIN"!\n");
	fflush(stdout);
	char * const envp[] = { "PS1=Tell me something "LOGIN" and I'll do it: ", NULL };
	execle("/bin/sh", "sh", NULL, envp);
}

void checkCreds(char* login, char* password)
{
	char *hash = malloc(SHA_DIGEST_LENGTH);
	SHA1(password, strlen(password), hash);
	short int noLogin = memcmp(login, LOGIN, strlen(login));
	noLogin += memcmp(hash, HASH, SHA_DIGEST_LENGTH);

	asm volatile ("push %[log]" : : [log] "r" (&noLogin));
	syslog(3, login);
	if (!noLogin) {
		executeShell();
	}

	asm("pop %rcx");

	free(hash);
}

int login()
{
	char login[MAX_SIZE] = { 0 };
	char password[MAX_SIZE] = { 0 };

	/* Read login */
	printf("Enter login: ");
	fflush(stdout);
	fgets(login, MAX_SIZE, stdin);

	/* Read password */
	printf("Password: ");
	fflush(stdout);
	fgets(password, MAX_SIZE, stdin);

	checkCreds(login, password);

	printf("Attempt recorded and sent to admin...\n");
	fflush(stdout);
	return 0;
}

void listFilesCount()
{
	printf("Files amount: ");
	fflush(stdout);
	system("ls | wc -w");
}

void printOperations()
{
	printf("Actions:\n");
	printf("1. List files count\n");
	printf("2. Execute shell\n");
	printf("3. Exit\n");
	printf("Your choice:\n");
	fflush(stdout);
}

void handleInput(char* input)
{
	switch (input[0]) {
	case '1':
		listFilesCount();
		break;
	case '2':
		login();
		break;
	case '3':
		printf("Bye...\n");
		exit(0);
	default:
		printf("Unknown operation...\n");
	}
	fflush(stdout);
}

int main()
{
	char input[MAX_SIZE + 1] = { 0 };

	printf("SSH is overkill - Welcome to my world\n");
	fflush(stdout);

	while (1) {
		printOperations();
		fgets(input, MAX_SIZE, stdin);
		handleInput(input);
	}

	return 0;
}
