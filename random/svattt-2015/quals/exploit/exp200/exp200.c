/* /
/home/l4w/llvm-3.7.0/bin/clang -m32  -D_FORTIFY_SOURCE=2 -O2 exp200.c -o exp200
 */

#include <stdio.h>
#include <stdlib.h>
#include <string.h>

int TOTAL = 4;
char* COFFEE[] = {"Vietnamese Coffee","Milk Coffee","Classic Jelly","Water"};
int PRICES[] = {3,3,4,1};

typedef struct orders_struct{
	int type_coffe;
	unsigned int quantity;
} ORDERS;


ORDERS TOTAL_ORDERS[5];
unsigned int SUM = 0;

char* READFILE(char* filename){
	FILE *f = fopen(filename,"rb");
	fseek(f, 0, SEEK_END);
	long fsize = ftell(f);
	fseek(f, 0, SEEK_SET);
	char *RESULT = malloc(fsize + 1);
	fread(RESULT, fsize, 1, f);
	fclose(f);
	return RESULT;
}

void print_menu(){
	int i,n;
	puts("------------------------------------------------------------");
	puts("                            MENU                           |");
	puts("-----------------------------------------------------------+");
	for(i = 0;i<TOTAL;i++){
		printf("%01d\t|%30s|\t%05d VND  |\n",i,COFFEE[i],PRICES[i]*10000);
		printf("--------+------------------------------+-------------------+\n");
	}
}

void order(){
	int type_coffe;
	unsigned int quantity,sum;

	if(SUM >= 5) return;
	puts("Which one, sir?");
	do{
		type_coffe = get_choice();
		if(type_coffe > 3) puts("What?");
	}while((type_coffe > 3));
	puts("How many?");
	quantity = get_choice();
	
	TOTAL_ORDERS[SUM].type_coffe = type_coffe;
	TOTAL_ORDERS[SUM].quantity = quantity;

	SUM++;
	puts("Okay, sir!");


}

void modify(){
	int id,quantity;
	ORDERS* this_order;


	printf("Which one, sir?\n");
	id = get_choice();
	if((signed int)id >= (signed int)SUM){
		puts("What?");
		return;
	}
	puts("Okay, sir...and ?");
	quantity = get_choice();
	this_order = &TOTAL_ORDERS[id];
	this_order->quantity = quantity;

	puts("Got it, sir!");


}

void review(){
	int i,n;
	printf("\
+-------------------------------------+\n\
|                                     |\n\
|            0xCOFFE SHOP             |\n\
|                                     |\n\
|        Timestamp: %10d        |\n\
|                                     |\n\
|                                     |\n",time(0));
	
	ORDERS* this_order;
	unsigned int TOTAL_SUM = 0;
	for(i = 0; i < SUM; i++){
		this_order = &TOTAL_ORDERS[i];
		printf("| %1d. %-20s  %4d C     |\n",i,COFFEE[this_order->type_coffe],this_order->quantity);

		TOTAL_SUM += this_order->quantity * PRICES[this_order->type_coffe];
	}
	printf("|                                     |\n|                                     |\n");
	printf("|\tTotal\t%10u VND        |\n",TOTAL_SUM*10000);
	printf("|                                     |\n|                           THANK YOU!|\n+-------------------------------------+\n");
}

void checkout(){
	char NAME[128];
	memset(NAME,'\0',128);
	printf("Your name, sir: ");
	read(0,NAME,128);
	NAME[strlen(NAME)-1] = '\0';
	printf("Thank you Mr. %s! We will deliver it very soon.\n",NAME);
}

void print_cmd(){
	puts("1. Show menu");
	puts("2. Order");
	puts("3. Modify an order");
	puts("4. Review an order");
	puts("5. Secure checkout");
	puts("6. Exit");
}


int get_choice(){
	int tmp;
	printf(">>> ");
	scanf("%d",&tmp);
	return tmp;
}

int main(){
	char password[128];
	char buffer[128];
	int n,cmd;
	
	alarm(30);
	setvbuf(stdout, NULL, _IONBF, 0);
	memset(buffer,'\0',128);
	memset(password,'\0',128);
	chdir("/home/exp200/");


	FILE * pFile;
	pFile = fopen("password.txt","rb");
	fread(password,1,32,pFile);
	fclose(pFile);

	char* FLAG = READFILE("flag.txt");
	
	printf("Enter password: ");
	
	n = read(0,buffer,128) - 1;


	

	if(n > 1)
		if(!strncmp(password,buffer,n))
		{
			printf("%s\n----------------------------------\n",READFILE("coffee.txt"));
			printf("Welcome to 0xCOFFE SHOP!\n");
			
			do{
				print_cmd();
				switch(cmd = get_choice()){
					case 1:
						print_menu();break;
					case 2:
						order(); break;
					case 3:
						modify();break;
					case 4:
						review();break;
					case 5:
						checkout(); break;
					case 6:
						printf("Bye!\n");
					default:
						cmd = 6;
						break;
				}
			}while(cmd != 6);

			
		} else {
			printf("%s is incorrect password!",buffer);
			return -1;
		}

		free(FLAG);
	
}