#!/usr/bin/python
from ctypes import *
import sys,os
import urllib



libc = CDLL("libc.so.6")
#C is love, C is life <3
libc.chdir("/home/noname/Workspace/SVATTT/exploit/exp100-python/")
_ = CDLL("./filter.so")
write = libc.write
open_ = libc.open
read_ = libc.read
close = libc.close
strcpy = libc.strcpy
strcat = libc.strcat
strlen = libc.strlen
memcpy = libc.memcpy



HTTP_503 = """
<title>503 - Error</title>
<pre>
Something went wrong :(

555555555555555555      000000000      333333333333333   
5::::::::::::::::5    00:::::::::00   3:::::::::::::::33 
5::::::::::::::::5  00:::::::::::::00 3::::::33333::::::3
5:::::555555555555 0:::::::000:::::::03333333     3:::::3
5:::::5            0::::::0   0::::::0            3:::::3
5:::::5            0:::::0     0:::::0            3:::::3
5:::::5555555555   0:::::0     0:::::0    33333333:::::3 
5:::::::::::::::5  0:::::0 000 0:::::0    3:::::::::::3  
555555555555:::::5 0:::::0 000 0:::::0    33333333:::::3 
            5:::::50:::::0     0:::::0            3:::::3
            5:::::50:::::0     0:::::0            3:::::3
5555555     5:::::50::::::0   0::::::0            3:::::3
5::::::55555::::::50:::::::000:::::::03333333     3:::::3
 55:::::::::::::55  00:::::::::::::00 3::::::33333::::::3
   55:::::::::55      00:::::::::00   3:::::::::::::::33 
     555555555          000000000      333333333333333   
</pre>
"""

def status_500(debug=""):
	buffer = create_string_buffer(len(HTTP_503))
	strcpy(buffer,HTTP_503)
	write(1,"HTTP/1.1 503 Internal Server Error\r\n",36)
	write(1,"X-Debug: ",9)
	write(1,debug,len(debug))
	write(1,"\r\n\r\n",4)
	write(1,buffer,strlen(buffer))
	libc.exit(-1)

QUERY_STRING = ""

close(2)

try:
	request = create_string_buffer(1024)
	read_(0,request,1024)

	REQUEST_HEADER = request.raw.split("\r\n")[0]

	if REQUEST_HEADER.startswith('GET /'):
		QUERY_STRING = urllib.unquote(REQUEST_HEADER[5:].split('HTTP/1')[0].strip())
		
		if _.blacklist(QUERY_STRING):
			status_500(QUERY_STRING)
			
		libc.chdir("./data/")
		content = urllib.urlopen(QUERY_STRING).read()

		buffer = create_string_buffer(1024)
		strcpy(buffer,"HTTP/1.1 200 OK\r\nContent-Type: text/html\r\n\r\n")
		
		
		write(1,buffer,strlen(buffer.raw))
		write(1,content,len(content))
	
	else:
		status_500(QUERY_STRING)

except:
	status_500(QUERY_STRING)