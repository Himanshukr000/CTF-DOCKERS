# Diffie Hellman MitM

## Challenge
The challenge requires players to do a live mitm attack on a diffie-hellmann key exchange.

## Setup

Place the entire `diffie_mitm` folder into the challenges folder for Naumachia. Add the appropriate lines to the Naumachia config:
```
challenges:
    # [required] An indiviual challenge config. The key is the challenge name
    # This should be a valid unix filename and preferably short
    diffie:
        # [default: 1194] The exposed external port for this challenges OpenVPN server
        port: 2000
        # [required] The compose files to which define this challenge
        # Paths should be relative to the challenges directory
        files:
            - diffie_mitm/docker-compose.yml
            - common/docker-compose.yml
```

## Solution
The solution requires a few steps. 
1. VPN into Naumachia environment
2. Start ettercap `ettercap -G`
3. Set to unified listen on `tap0`
4. Scan for hosts
5. Start wireshark
6. Start arp spoofing in sniff remote connections mode
7. Note the ip of "bob" and "alice"
8. Stop arp spoofing
9. Start MitM Attack application on port 4000: `python3 attacker.py`
10. Enable IPv4 forwarding: `sysctl -w net.ipv4.ip_forward=1`
11. Redirect Alice's requests to attacker:  
`iptables -t nat -A PREROUTING -i tap0 -p tcp --dport 5005 -j REDIRECT --to-port 4000`
12. In ettercap add Alice to target 1 and Bob to target 2
13. Start arp spoofing in poison one way mode
14. It may take a the attacker a few tries to work.
15. Read the script for the flag
